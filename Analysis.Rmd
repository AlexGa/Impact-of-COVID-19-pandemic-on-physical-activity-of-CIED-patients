---
title: Impact of coronavirus disease (COVID-19) pandemic on physical activity of patients
  with cardiac implantable electronic devices
author: "Alexander Gabel"
date: "05/13/2022"
always_allow_html: yes
output:
  github_document:
    df_print: paged
    toc: true
    toc_depth: 2
  html_document:
    df_print: paged
    code_folding: hide
    toc: yes
    toc_depth: '2'
    toc_float:
      collapsed: no
---

# Setup libraries and Functions
```{r, message=FALSE}
library(readr)
library(dplyr)
library(ggplot2)
library(knitr)
library(tibble)
library(tidyr)
library(kableExtra)
library(RColorBrewer)
library(tidyverse)
library(nparLD)
library(ggsignif)
```

### Define ggplot plot themes

```{r}
ggStyle <- ggplot2::theme_classic() + 
  ggplot2::theme(axis.title = ggplot2::element_text(size = 12, face = "bold"),
                 axis.line = ggplot2::element_line(colour = "black"),
                 axis.text.x = ggplot2::element_text(colour = "black", face = "bold", size = 12), 
                 axis.text.y = ggplot2::element_text(colour = "black", face = "bold", size = 12),
                 legend.position = c(0, 0.95),
                 legend.justification = c("left", "top"),
                 legend.box.just = "left",
                 legend.margin = margin(6, 6, 6, 6),
                 legend.text = ggplot2::element_text(size = 12), 
                 legend.title = ggplot2::element_text(face = "bold", size = 12), 
                 legend.background = ggplot2::element_rect(fill = NA),
                 plot.title = ggplot2::element_text(face = "bold"),
                 plot.caption = ggplot2::element_text(face = "bold"),
                 strip.text = ggplot2::element_text(face="bold", size=12),
                 strip.background = ggplot2::element_rect(fill = "white"),
                 plot.margin = ggplot2::unit(c(0,1,0,0.25), "cm"))

ggStyle_ts <- ggplot2::theme_classic() + 
  ggplot2::theme(axis.title = ggplot2::element_text(size = 12, face = "bold"),
                 axis.line = ggplot2::element_line(colour = "black"),
                 axis.text.x = ggplot2::element_text(colour = "black", face = "bold", size = 12, angle = 45, hjust = 1, vjust = 1), #hjust = 0, vjust = 0.5), 
                 axis.text.y = ggplot2::element_text(colour = "black", face = "bold",size = 12),
                 legend.margin = margin(6, 6, 6, 6),
                 legend.text = ggplot2::element_text(size = 12), 
                 legend.title = ggplot2::element_text(face = "bold", size = 12), 
                 legend.background = ggplot2::element_rect(fill = NA),
                 plot.title = ggplot2::element_text(face = "bold"),
                 plot.caption = ggplot2::element_text(face = "bold"),
                 strip.text = ggplot2::element_text(face="bold", size=12),
                 strip.background = ggplot2::element_rect(fill = "white"),
                 plot.margin = ggplot2::unit(c(0.25,1,0,0), "cm"))
```

### Functions

```{r}
get_icd_data <- function(ds, variable){
  
  ds_filter <- filter_complete_dataset(ds = data_set, variable = variable)
  ds_interval <- summarise_intervals(ds = ds_filter, variable = variable, add = T)

}

filter_complete_dataset <- function(ds, variable, correct_weekday = F){
  
  ds_all <- ds %>% filter(!is.na(!!sym(variable)))
  ids_in_intervals <- ds_all %>% group_by(ID) %>% summarise(n_intervals = length(unique(Interval))) %>% filter(n_intervals == 12) %>% pull(ID)
  ds_all <- ds_all %>% filter(ID %in% ids_in_intervals)
  
  if(correct_weekday){
    ds_all <- ds_all %>% mutate(!!variable := lm(!!sym(variable) ~ Weekday, data = cur_data())$res)
  }
  
  return(ds_all)
}

summarise_intervals <- function(ds, variable, add = F){
  
  ds_interval <- c()
  
  if(add){
    
    ds_interval <- ds %>% group_by(ID, year, IntGroup, Interval, Gender, Age) %>% 
      summarise(!!variable := sum(!!sym(variable)), .groups = 'drop')
    
  }else{
    
    ds_interval <- ds %>% group_by(ID, year, IntGroup, Interval, Gender, Age) %>% 
      summarise(!!variable := mean(!!sym(variable)), .groups = 'drop')
    
  }
  
  ds_interval$ID <- factor(ds_interval$ID, unique(ds_interval$ID))
  ds_interval$Gender <- factor(ds_interval$Gender, unique(ds_interval$Gender))
  ds_interval$IntGroup <- factor(ds_interval$IntGroup, unique(ds_interval$IntGroup))
  ds_interval$Interval <- factor(ds_interval$Interval, levels = unique(ds_interval$Interval))
    
  ds_interval <- ds_interval %>% mutate(AgeCat = if_else((Age <= 70), "young", "old"))
    
  ds_interval$AgeCat <- factor(ds_interval$AgeCat, levels = unique(ds_interval$AgeCat))

  return(ds_interval)
}

plot_longitude <- function(ds, x, variable, ylim, lockDownDates, first_cases, lockdownLabs, n_subs, sel_year){
  
  mean_overall <- mean(ds %>% pull(!!sym(variable)))
  
  segment_means_df <- data.frame(ds %>% group_by(Interval) %>% summarise(mean = mean(!!sym(variable))), 
                                 xstart = lockDownDates[-length(lockDownDates)], xend = lockDownDates[-1]-1)
  
  season_cols <- alpha(colour = c("gray", "green4", "orange", "tan4"), alpha = 0.6)
  
  season_bars <- data.frame(xstart = as.Date(c("2019-01-01", "2019-03-01", "2019-06-01", 
                                               "2019-09-01", "2019-12-01")), 
                            xend = as.Date(c("2019-03-01", "2019-06-01", "2019-09-01", 
                                               "2019-12-01", "2019-12-31")),
                            color = c(season_cols, season_cols[1]),
                            season = c("winter", "spring", "summer", "autmn", "winter")) %>%
                  dplyr::mutate(xstart = lubridate::`year<-`(xstart, sel_year), 
                                xend= lubridate::`year<-`(xend, sel_year))
  
  ggplot2::ggplot(data = ds, ggplot2::aes_string(x = x, y = variable)) + ggplot2::geom_line() + 
    ggplot2::theme(legend.position = "none") +
    ggStyle_ts +
    geom_segment(data = season_bars, aes(x = xstart, xend = xend), y = ylim[1]-0.25, yend = ylim[1]-0.25,  
                 col = season_bars$color, lwd = 6, ) + 
    ggplot2::geom_hline(yintercept = mean_overall, col = "green4", lwd = 1, linetype = "dashed") + 
    ggplot2::geom_vline(xintercept = lockDownDates) + 
    ggplot2::geom_vline(xintercept = first_cases, col ="red", linetype = "dashed") + 
    ggplot2::annotate(geom="label", x = lockdownLabs, 
                      y = max(ylim), 
                      label = LETTERS[1:6]) + ggplot2::ylim(ylim) + 
    geom_segment(data = segment_means_df, aes(x = xstart, xend = xend, y = mean, yend = mean), lwd = 1, col = "blue2") +
    ggplot2::scale_x_date(breaks = lockDownDates, expand = c(0,0)) 
    # ggplot2::annotate(geom="text", x = lockDownDates[3] + 40, 
    #                   y = min(ylim), 
    #                   label = paste0("#Subjects: ", n_subs))
}

number_to_star <- function(signif_df){
  
    signif_df <- signif_df %>% mutate(significant = case_when((significant == "<0.05") ~ "*",
                                                              (significant == "<0.01") ~ "**",
                                                              (significant == "<0.001") ~ "***",
                                                              (significant == "<0.0001") ~ "****",
                                                              (significant == "ns") ~ "ns"))
    return(signif_df)
}

add_signif_bar_year <- function(ds, variable, star_df){
  
  ylim_new <- ds %>% group_by(IntGroup) %>% summarise(ymin = boxplot.stats(!!sym(variable))$stats[1],
                                                      ymax = boxplot.stats(!!sym(variable))$stats[5]) %>% 
    summarise(min(ymin), max(ymax)) %>% as.numeric()
  ylim_new <- ylim_new * 1.2
  
  ymax_data <- ds %>% group_by(IntGroup) %>% summarise(ymax = boxplot.stats(!!sym(variable))$stats[5])
  
  anno_dat <- data.frame(x1 = ymax_data$IntGroup[-length(ymax_data$IntGroup)], 
                         x2 = ymax_data$IntGroup[-1]) %>% droplevels()
  
  anno_dat <- data.frame(anno_dat, 
                         y = apply(anno_dat, 1, function(i) max(ymax_data %>% filter(IntGroup %in% i) %>% pull(ymax))) * 1.05
  )
  
  star_df <- number_to_star(signif_df = star_df)
  
  anno_dat <- anno_dat %>% inner_join(star_df, by = c("x1" = "group1", "x2" = "group2")) %>% filter(significant != "ns")
  
  if(dim(anno_dat)[1] == 0){
    return(NULL)
    
  }else{
    offset <- (max(ylim_new) - max(anno_dat$y))/length(anno_dat$y)
    
    ggsignif::geom_signif(annotations = anno_dat$significant, tip_length = 0.005,
                          y_position = anno_dat$y + cumsum(c(0, rep(offset, length(anno_dat$y)-1))), 
                          xmin=as.character(anno_dat$x1), xmax=as.character(anno_dat$x2))
  }
}

add_signif_bar_1920 <- function(ds, variable, star_df){

  anno_dat <- ds %>% group_by(IntGroup) %>% summarise(ymax = boxplot.stats(!!sym(variable))$stats[5]) %>% 
    group_by(IntGroup) %>% summarise(ymax = max(ymax) * 1.05)
  
  anno_dat <- cbind(anno_dat,  xmin = seq(0.8, 0.8+nrow(anno_dat)-1, by = 1), xmax = seq(1.2, 0.2 + nrow(anno_dat), by = 1))
  
  star_df <- number_to_star(signif_df = star_df)
  anno_dat <- anno_dat %>% inner_join(star_df, by = c("IntGroup" = "group1")) %>% filter(significant != "ns")
  
  if(dim(anno_dat)[1] == 0){
    return(NULL)
  }

  geom_signif(
      y_position = anno_dat$ymax, xmin = anno_dat$xmin, xmax = anno_dat$xmax,
      annotation = anno_dat$significant,  tip_length = 0.005)
}

boxplot_each_year <- function(ds, variable, fill_color, xlabel, ylabel, main_title, ylim_new, pattern = NULL, show.legend = T, legend.labels = NULL){
       
  ggDesign <- ggStyle + 
               ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 0),
                              legend.position = "none")
  
  if(is.null(pattern)){
    
    bxplt <- ggplot2::ggplot(data = ds, ggplot2::aes_string(x = "IntGroup", y = variable)) + 
               ggplot2::geom_point(size = -1) + 
               ggplot2::stat_boxplot(geom = "errorbar", width = 0.5, position = position_dodge(width = 0.75)) + 
               ggplot2::geom_boxplot(notch=F, outlier.colour="black", outlier.fill="black", outlier.size = -1, size = 0.8, 
                                     show.legend = FALSE, position = position_dodge(width = 0.75), fill = fill_color) + 
               ggDesign +
               ggplot2::xlab(xlabel) + 
               ggplot2::ylab(ylabel) +      
               ggplot2::scale_fill_manual(labels = legend.labels, values = fill_color) +
               ggplot2::coord_cartesian(ylim = ylim_new) 
  }else{
    
    bxplt <- ggplot2::ggplot(data = ds, ggplot2::aes_string(x = "IntGroup", y = variable)) + 
              ggplot2::geom_point(size = -1) + 
              ggplot2::stat_boxplot(geom = "errorbar", width = 0.5, position = position_dodge(width = 0.75)) + 
              ggpattern::geom_boxplot_pattern(notch=F, outlier.colour="black", outlier.fill="black", outlier.size = -1, size = 0.8, 
                                             show.legend = FALSE, position = position_dodge(width = 0.75), fill = fill_color, 
                                             pattern_size = 0.5, pattern = pattern, pattern_alpha = 0.75, pattern_angle = 45) + 
             ggDesign +
             ggplot2::xlab(xlabel) + 
             ggplot2::ylab(ylabel) + 
             ggplot2::scale_fill_manual(labels = legend.labels, values = fill_color) +
             ggplot2::coord_cartesian(ylim = ylim_new) 
  }
  
   if(is.null(main_title)){
    
    bxplt <- bxplt +  ggplot2::theme(title = element_blank())
    
  }else{
    
    bxplt <- bxplt +  ggplot2::ggtitle(main_title)
  }
  
  if(show.legend){
    
    bxplt <- bxplt +  ggplot2::guides(fill = guide_legend(title.position = "top",
                                          keywidth = unit(0.5, "cm"),
                                          keyheight = unit(0.5, "cm"),
                                          override.aes = list(shape = 22, size = 8, stroke = 1), ncol = 2)) +  
                      ggplot2::theme(legend.position= "top",
                                     legend.box.just = "left",
                                     legend.margin = margin(1,1,1,1))
  
  }else{
    
     bxplt <- bxplt +  ggplot2::theme(legend.position = "none")
     
  }
  
  return(bxplt)
 
}

boxplot_btw_years <- function(ds, variable, fill_colors, pattern = NULL, main_title, xlabel, ylabel, ylim_new, show.legend = T, legend.labels = NULL){
  
  ggDesign <- ggStyle + 
    ggplot2::theme(legend.position = c(0.01, 0.97),
                   legend.justification = c("left", "top"),
                   legend.box.just = "left",
                   legend.margin = margin(6, 6, 6, 6),
                   legend.text = ggplot2::element_text(size = 12, face = "bold"), 
                   legend.title = ggplot2::element_blank(),
                   axis.text.x = ggplot2::element_text(angle = 0)) 
   
  
  if(is.null(pattern)){
    
    bxplt <- ggplot2::ggplot(data = ds, ggplot2::aes_string(x = "IntGroup", y = variable, fill = "year")) + 
      ggplot2::geom_point(size = -1) + 
      ggplot2::stat_boxplot(geom = "errorbar", width = 0.5, position = position_dodge(width = 0.75)) + 
      ggplot2::geom_boxplot(notch=F, outlier.colour="black", outlier.fill="black", outlier.size = -1, size = 0.8, 
                            show.legend = FALSE, position = position_dodge(width = 0.75)) + 
      ggDesign + 
      ggplot2::scale_fill_manual(labels = legend.labels, values = fill_colors) +
      ggplot2::scale_color_manual(values = rep("black", 4)) +
      ggplot2::xlab(xlabel) + 
      ggplot2::ylab(ylabel) + 
      ggplot2::coord_cartesian(ylim = ylim_new)
    
  }else{
    
    bxplt <- ggplot2::ggplot(data = ds, ggplot2::aes_string(x = "IntGroup", y = variable, fill = "year")) + 
      ggplot2::geom_point(size = -1) + 
      ggplot2::stat_boxplot(geom = "errorbar", width = 0.5, position = position_dodge(width = 0.75)) +
      ggpattern::geom_boxplot_pattern(notch=F, outlier.colour="black", outlier.fill="black", outlier.size = -1, size = 0.8, 
                                      show.legend = FALSE, position = position_dodge(width = 0.75), 
                                      pattern_size = 0.5, pattern = pattern, pattern_alpha = 0.75, pattern_angle = 45) + 
      ggDesign + 
      ggplot2::scale_fill_manual(labels = legend.labels, values = fill_colors) +
      ggplot2::scale_color_manual(values = rep("black", 4)) +
      ggplot2::xlab(xlabel) + 
      ggplot2::ylab(ylabel) + 
      ggplot2::coord_cartesian(ylim = ylim_new) 
  }
  
  if(is.null(main_title)){
    
    bxplt <- bxplt +  ggplot2::theme(title = element_blank())
    
  }else{
    
    bxplt <- bxplt +  ggplot2::ggtitle(main_title)
  }
  
  if(show.legend){
    
    bxplt <- bxplt +  ggplot2::guides(fill = guide_legend(title.position = "top",
                                          keywidth = unit(0.5, "cm"),
                                          keyheight = unit(0.5, "cm"),
                                          override.aes = list(shape = 22, size = 8, stroke = 1), ncol = 2)) +  
                      ggplot2::theme(legend.position= "top",
                                     legend.box.just = "left",
                                     legend.margin = margin(1,1,1,1))
  
  }else{
    
     bxplt <- bxplt +  ggplot2::theme(legend.position = "none")
     
  }
  
  return(bxplt)
}

boxplot_year <- function(ds, variable, main_title, ymax = NULL, stats, show.legend = F, legend.labels = NULL,
                         pairs = paste0(LETTERS[1:5],"19",LETTERS[2:6],"19"), sel_year = 2019, sep_age = F, 
                         xlabel = "Time interval", ylabel = "Physical Activity"){
  
  order_letter <- c("AB","BC", "CD", "DE", "EF", "AC", "BD", "CE", "DF", "AD", "BE", "CF", "AE", "BF", "AF")
 
  # year_col <- data.frame(color = c("#A0A0A0FF","#DF8F44FF" ), year = c(2019, 2020), stringsAsFactors = F) 
  year_col <- data.frame(color = c("#A0A0A0FF","#4e60c7FF" ), year = c(2019, 2020), stringsAsFactors = F) 
  
  ylim_new <- ds %>% group_by(IntGroup) %>% summarise(ymin = boxplot.stats(!!sym(variable))$stats[1],
                                                      ymax = boxplot.stats(!!sym(variable))$stats[5]) %>% 
                                            summarise(min(ymin) * 0.8, max(ymax)*1.2) %>% as.numeric()
  
  ymax_data <- ds %>% group_by(IntGroup) %>% summarise(ymax = boxplot.stats(!!sym(variable))$stats[5])
  
  anno_dat <- data.frame(x1 = ymax_data$IntGroup[-length(ymax_data$IntGroup)], 
                         x2 = ymax_data$IntGroup[-1])
  
  anno_dat <- data.frame(anno_dat, 
                         y = apply(anno_dat, 1, function(i) max(ymax_data %>% filter(IntGroup %in% i) %>% pull(ymax))) * 1.05
                         )
  
  offset <- (max(ylim_new) - max(anno_dat$y))/length(anno_dat$y)
  
  bx_plt <- c()
  
  if(sep_age){
    
    age_cats <- levels(ds$AgeCat)
    bx_plt <- list()
    
    age_patterns <- c("stripe", "crosshatch")
    
    for(i in seq_along(age_cats)){
      
      if(i == 1){
        
        year_col <- data.frame(color = c("#908c8cff","#4455b3ff" ), year = c(2019, 2020), stringsAsFactors = F) 
        
      }
      if(i == 2){
        year_col <- data.frame(color = c("#b8b3b3ff","#949ed6ff" ), year = c(2019, 2020), stringsAsFactors = F) 
      }
      
      
      bx_plt[[i]] <- boxplot_each_year(ds = ds  %>% filter(year == sel_year, AgeCat == age_cats[i]), variable = variable, 
                                  fill_color = year_col[year_col$year == sel_year,]$color, 
                                  xlabel = xlabel, ylabel = ylabel, ylim_new = ylim_new, main_title = paste0(main_title, " ", age_cats[i]), pattern = NULL, show.legend = FALSE, legend.labels = paste0(year_col$year," ",rep(age_cats[i], 2)))
      
      star_df <- stats %>% filter(Age == age_cats[i])
      star_df <- star_df %>% dplyr::filter(star_df %>% dplyr::select(group1, group2) %>% mutate(gr = paste0(group1,group2) %in% pairs) %>% pull(gr)) %>% 
                             dplyr::select(group1, group2, significant) %>% 
                             dplyr::mutate(group1 = gsub(group1, pattern = "([0-9]*)", repl = ""),
                                           group2 = gsub(group2, pattern = "([0-9]*)", repl = ""))
      
      bx_plt[[i]] <- bx_plt[[i]] + add_signif_bar_year(ds = ds  %>% filter(year == sel_year, AgeCat == age_cats[i]), variable = variable, star_df = star_df)
    }
    
    names(bx_plt) <- age_cats
    
    bx_plt <- cowplot::plot_grid(bx_plt[[1]] + ggplot2::theme(plot.margin = ggplot2::margin(b = 3)), 
                                 bx_plt[[2]] + ggplot2::theme(plot.margin = ggplot2::margin(b = 3)), 
                                 # + ggplot2::theme(axis.text.y = ggplot2::element_blank(), 
                                 #                              axis.ticks.y = ggplot2::element_blank(),
                                 #                              axis.title.y = ggplot2::element_blank(),
                                 #                              axis.line.y = ggplot2::element_blank(),
                                 #                              plot.margin = ggplot2::margin(l = 0)),
                                 rel_heights = c(0.45,0.45))
    
  }else{
    
    bx_plt <- boxplot_each_year(ds = ds  %>% filter(year == sel_year), variable = variable, fill_color = year_col[year_col$year == sel_year,]$color, 
                                 xlabel = xlabel, ylabel = ylabel, ylim_new = ylim_new, main_title = main_title, show.legend = show.legend, legend.labels = legend.labels)
  
    star_df <- stats %>% rownames_to_column() %>% filter(Factor == "Time-Interval") 
    star_df <- star_df %>% dplyr::filter(star_df %>% dplyr::select(group1, group2) %>% mutate(gr = paste0(group1,group2) %in% pairs) %>% pull(gr)) %>% 
                           dplyr::select(group1, group2, significant) %>% 
                           dplyr::mutate(group1 = gsub(group1, pattern = "([0-9]*)", repl = ""),
                                         group2 = gsub(group2, pattern = "([0-9]*)", repl = ""))
  
    bx_plt <- bx_plt + add_signif_bar_year(ds = ds, variable = variable, star_df = star_df)
  }
 
  
  return(bx_plt)
  
}

boxplot_1920 <- function(ds, variable, main_title = NULL, ymax = NULL, stats, 
                         ylabel = variable, xlabel = "Time interval", sep_age = F, legend.labels = NULL, show.legend = F){
  
  ds$year <- factor(ds$year, levels = c(2019, 2020))
  # year_col <- data.frame(color = c("#A0A0A0FF","#DF8F44FF" ), year = c(2019, 2020), stringsAsFactors = F) 
  year_col <- data.frame(color = c("#A0A0A0FF","#4e60c7FF" ), year = c(2019, 2020), stringsAsFactors = F) 
  
  ylim_new <- ds %>% group_by(IntGroup, Interval) %>% summarise(ymin = boxplot.stats(!!sym(variable))$stats[1],
                                                                ymax = boxplot.stats(!!sym(variable))$stats[5], .groups = 'drop') %>% 
              summarise(ymin = min(ymin) * 0.8, ymax = max(ymax)*1.2) %>% as.numeric()
  
  pairs <- paste0(LETTERS[1:6],"19",LETTERS[1:6],"20")
  
  bx_plt <- c()
  
  if(sep_age){
    
    age_cats <- levels(ds$AgeCat)
    bx_plt <- list()
    
    age_patterns <- c("stripe", "crosshatch")
     
    for(i in seq_along(age_cats)){
      
      if(i == 1){
        
        year_col <- data.frame(color = c("#908c8cff","#4455b3ff" ), year = c(2019, 2020), stringsAsFactors = F) 
        
      }
      if(i == 2){
        year_col <- data.frame(color = c("#b8b3b3ff","#949ed6ff" ), year = c(2019, 2020), stringsAsFactors = F) 
      }
      
      bx_plt[[i]] <- boxplot_btw_years(ds = ds %>% filter(AgeCat == age_cats[i]), variable = variable, 
                                  fill_colors = year_col$color, 
                                  xlabel = xlabel, ylabel = ylabel, ylim_new = ylim_new, main_title = main_title, pattern = NULL, legend.labels = paste0(year_col$year," ",rep(age_cats[i], 2)))
      
      star_df <- stats %>% filter(Age == age_cats[i])
      star_df <- star_df %>% dplyr::filter(star_df %>% dplyr::select(group1, group2) %>% mutate(gr = paste0(group1,group2) %in% pairs) %>% pull(gr)) %>% 
                             dplyr::select(group1, group2, significant) %>% 
                             dplyr::mutate(group1 = gsub(group1, pattern = "([0-9]*)", repl = ""),
                                           group2 = gsub(group2, pattern = "([0-9]*)", repl = ""))
      
      bx_plt[[i]] <- bx_plt[[i]] + add_signif_bar_1920(ds = ds  %>% filter(AgeCat == age_cats[i]), variable = variable, star_df = star_df)
    }
    
    names(bx_plt) <- age_cats
    
    
    bx_plt <- cowplot::plot_grid(bx_plt[[1]],
                                 bx_plt[[2]])
      
    # bx_plt <- cowplot::plot_grid(bx_plt[[1]] + ggplot2::theme(plot.margin = ggplot2::margin(r = 0)), 
    #                              bx_plt[[2]] + ggplot2::theme(axis.text.y = ggplot2::element_blank(), 
    #                                                           axis.ticks.y = ggplot2::element_blank(),
    #                                                           axis.title.y = ggplot2::element_blank(),
    #                                                           axis.line.y = ggplot2::element_blank(),
    #                                                           plot.margin = ggplot2::margin(l = 0)),
    #                              rel_widths = c(0.525,0.475))
  }else{
    
     bx_plt <- boxplot_btw_years(ds = ds, variable = variable,  fill_colors = year_col$color, pattern = NULL, main_title = main_title, xlabel = xlabel, ylabel = ylabel,  ylim_new = ylim_new, show.legend = show.legend, legend.labels = legend.labels)
      
     star_df <- stats %>% tibble::rownames_to_column() %>% filter(Factor == "Time-Interval")
     star_df <- star_df %>% filter(star_df %>% dplyr::select(group1, group2) %>% mutate(gr = paste0(group1, group2) %in% pairs) %>% 
                pull(gr)) %>% dplyr::select(group1, group2, significant) %>% 
                mutate(group1 = gsub(group1, pattern = "([0-9]*)", repl = ""),
                       group2 = gsub(group2, pattern = "([0-9]*)", repl = ""))
    
      bx_plt <- bx_plt + add_signif_bar_1920(ds = ds, variable = variable, star_df = star_df)
  }
  
  return(bx_plt)
}

event_barplot <- function(ds, variable, xlabel, ylabel){
    
  #year_col <- data.frame(color = c("#A0A0A0FF","#DF8F44FF" ), year = c(2019, 2020), stringsAsFactors = F) 
  year_col <- data.frame(color = c("#A0A0A0FF","#4e60c7FF" ), year = c(2019, 2020), stringsAsFactors = F) 
  
  ds$IntGroup <- factor(ds$IntGroup)
  ds$year <- factor(ds$year)
  
  bar_plt <- ggplot2::ggplot(ds, ggplot2::aes_string(x = "IntGroup", y = variable, fill = "year")) +
    ggplot2::geom_bar(stat = "identity", col = "black") +
    ggplot2::facet_wrap(~year) + 
    ggStyle + ggplot2::scale_fill_manual(values = year_col$color) +
    ggplot2::xlab(xlabel) +
    ggplot2::ylab(ylabel) +
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 0),
                   legend.position = "none") 
  
  bar_plt
}

rankTest_pairwise <- function(ds, variable, consider_gender = T){

  int_groups <- levels(ds$Interval)
  int_combs <- combn(x = int_groups, m = 2)
  
  res_nparLD <- c()
  stats_ats <- c()
  
  if(consider_gender){
    
    res_nparLD <- apply(int_combs, 2, function(intGrp){
    
      ds_sub_interval <- as.data.frame(ds %>% filter(Interval %in% intGrp) %>% droplevels())
      res <- f2.ld.f1(y = ds_sub_interval %>% pull(!!sym(variable)), 
                      time = as.character(ds_sub_interval$Interval), 
                      group1 = as.character(ds_sub_interval$AgeCat), 
                      group2 = as.character(ds_sub_interval$Gender), 
                      subject = as.character(ds_sub_interval$ID), 
                      time.order = levels(ds_sub_interval$Interval), 
                      group1.name = "Age", group2.name = "Gender", plot.RTE = FALSE, description = FALSE)
    res
  })
     stats_ats <- data.frame(Factor = c("Age", "Gender", "Time-Interval", "Age:Gender", "Age:Time-Interval", "Gender:Time-Interval", "Age:Gender:Time-Interval"), 
                          group1 = rep(int_combs[1,], each = 7), group2 = rep(int_combs[2,], each = 7), 
                          do.call("rbind", lapply(res_nparLD, function(elem)elem$ANOVA.test))) %>% dplyr::select(!df)
  }else{
    
    text_formula <- paste0(variable," ~  Interval * AgeCat")
    
    res_nparLD <- apply(int_combs, 2, function(intGrp){
      
      res <- nparLD(eval(parse(text = text_formula)), data = as.data.frame(ds %>% filter(Interval %in% intGrp)), 
                    subject = "ID", description = FALSE, plot.CI = FALSE)
      res
    })
    
     stats_ats <- data.frame(Factor = c("Age", "Time-Interval", "Age:Time-Interval"), 
                          group1 = rep(int_combs[1,], each = 3), group2 = rep(int_combs[2,], each = 3), 
                          do.call("rbind", lapply(res_nparLD, function(elem)elem$ANOVA.test))) %>% dplyr::select(!df)
  }
  
  
  stats_ats <- data.frame(stats_ats, "p.adj(BY)" = p.adjust(stats_ats$p.value, method = "BY"), check.names = F) %>% 
    mutate(significant = case_when((`p.adj(BY)` >= 0.05) ~ "ns",
                                   (`p.adj(BY)` < 0.05 & `p.adj(BY)` >= 0.01) ~ "<0.05",
                                   (`p.adj(BY)` < 0.01 & `p.adj(BY)` >= 0.001) ~ "<0.01",
                                   (`p.adj(BY)` < 0.001 & `p.adj(BY)` >= 0.0001) ~ "<0.001",
                                   (`p.adj(BY)` < 0.0001 & `p.adj(BY)` >= 0) ~ "<0.0001"))
  
  stats_groups <- ds %>% group_by(Interval, AgeCat) %>% 
    summarise("Mean ± SD" = paste0(round(mean(!!sym(variable)), 2), " ± ", round(sd(!!sym(variable)), 2)), Mean = mean(!!sym(variable)))
  
  FC_stats <- apply(int_combs, 2, function(intGrp){
    
    fc_stats <- ds %>% filter(Interval %in% intGrp) %>% dplyr::select(ID, Interval, !!sym(variable), AgeCat) %>% 
      tidyr::pivot_wider(names_from = Interval, values_from = !!sym(variable)) %>% mutate(FC = !!sym(intGrp[1])/!!sym(intGrp[2]))  
    
    print(fc_stats)
    
    fc_desc <- fc_stats %>% group_by(AgeCat) %>% summarise(FC = paste0(round(mean(FC),3), " ± ", round(sd(FC),3))) %>% 
      tidyr::pivot_wider(names_from = AgeCat, values_from = FC) %>% mutate(Comparison = paste0(intGrp, collapse = ""))
    
    colnames(fc_desc)[1:2] <- c("FC(old)", "FC(young)")
    
    fc_wilcox <- fc_stats %>% group_by(AgeCat) %>% count() %>% pivot_wider(id_cols = c(AgeCat, n), names_from = AgeCat, values_from = n)
    fc_wilcox <- data.frame(Test = "noTest", group1 = colnames(fc_wilcox)[1], group2 = colnames(fc_wilcox)[2], "n1" = as.numeric(fc_wilcox[1,1]), "n2" = as.numeric(fc_wilcox[1,2]), statistic = "noStat", p = 1)
    
    try(fc_wilcox <- fc_stats %>% rstatix::wilcox_test(FC ~ AgeCat), silent = T)
    
    cbind(fc_desc, fc_wilcox)
  })
  
  fc_stats_pairs <- do.call("rbind", FC_stats)[,-4]
  fc_stats_pairs <- fc_stats_pairs %>% dplyr::mutate("p.adj(BY)" = p.adjust(p,"BY"))

  if(!consider_gender){
    
  stats_ats_time <- data.frame(group1 = rep(int_combs[1,], each = 2), group2 = rep(int_combs[2,], each = 2), 
                               Age = c("old", "young"),
                               do.call("rbind", lapply(res_nparLD, function(elem)elem$ANOVA.test.time))) %>% dplyr::select(!df)  
    
  stats_ats_time <- stats_ats_time %>% inner_join(stats_groups, by = c("Age" = "AgeCat", "group1" = "Interval"), suffix = c(" (group1)"," (group2)")) %>% 
                                       inner_join(stats_groups, by = c("Age" = "AgeCat", "group2" = "Interval"), suffix = c(" (group1)"," (group2)")) %>% 
                                       dplyr::mutate("Fold change (group2/group1)" = round(`Mean (group2)`/`Mean (group1)`, 3)) %>% 
                                       dplyr::select(!dplyr::matches("Mean \\(group"))
  
  stats_ats_time <- stats_ats_time[,c(1:3, 6:8, 4:5)]

  stats_ats_time <- data.frame(stats_ats_time, "p.adj(BY)" = p.adjust(stats_ats_time$p.value, method = "BY"), check.names = F) %>% 
    mutate(significant = case_when((`p.adj(BY)` >= 0.05) ~ "ns",
                                   (`p.adj(BY)` < 0.05 & `p.adj(BY)` >= 0.01) ~ "<0.05",
                                   (`p.adj(BY)` < 0.01 & `p.adj(BY)` >= 0.001) ~ "<0.01",
                                   (`p.adj(BY)` < 0.001 & `p.adj(BY)` >= 0.0001) ~ "<0.001",
                                   (`p.adj(BY)` < 0.0001 & `p.adj(BY)` >= 0) ~ "<0.0001"))
  
  
  btw_years <- apply(matrix(nc = 2, paste0(rep(LETTERS[1:6], each=2), 19:20), byrow = T),1,function(i)paste0(i, collapse=""))
  btw_ints <- apply(matrix(nc = 2, paste0(rep(LETTERS[1:6], each=2)[-c(1,12)], rep(19:20, each = 10)), byrow = T),1,function(i)paste0(i, collapse=""))
  
  stats_df_full <- stats_ats_time
  
  split_df <- function(stats_df_full, groups){
    
    stats_df_split <- stats_df_full %>% mutate(g1g2 = paste0(group1,group2)) %>% filter(g1g2 %in% groups) %>% dplyr::select(-g1g2)
    
    lapply(split(stats_df_split, stats_df_split$Age), function(sub_df){
      sub_df <- sub_df %>% dplyr::select(-Age) %>% 
                tidyr::pivot_longer(cols = starts_with("group"), names_to = "group", values_to = "Interval") %>% 
                as.data.frame(check.names = F, stringsAsFactors = F) 
      
      new_sub_df <- as.data.frame(t(apply(sub_df, 1, function(col_vals){
        
        col_vals[c(9,grep(colnames(sub_df), pattern = col_vals[8], ignore.case = T)[1], 5:7, 3)]
      })), stringsAsFactors = F)
      
      colnames(new_sub_df)[-2] <- colnames(sub_df)[c(9,5:7,3)] 
      colnames(new_sub_df)[2] <- "Mean ± SD"
      new_sub_df
    })
  }
 
  ats_sub_list_years <- split_df(stats_ats_time, groups = btw_years)
  ats_sub_list_ints <-split_df(stats_ats_time, groups = btw_ints)
  
  pairs_result_list <- list(stats = stats_groups, stats_ats = stats_ats, 
                            stats_ats_time = stats_ats_time,
                            ats_sub_list_years = ats_sub_list_years, ats_sub_list_ints = ats_sub_list_ints,
                            fc_stats_pairs = fc_stats_pairs)
  }else{
    
    stats_groups_gender <- ds %>% group_by(Interval, Gender) %>% 
    summarise("Mean ± SD" = paste0(round(mean(!!sym(variable)), 2), " ± ",round(sd(!!sym(variable)), 2)), Mean = mean(!!sym(variable)))
  
    FC_stats <- apply(int_combs, 2, function(intGrp){
    
      fc_stats <- ds %>% filter(Interval %in% intGrp) %>% dplyr::select(ID, Interval, !!sym(variable), Gender) %>% 
        tidyr::pivot_wider(names_from = Interval, values_from = !!sym(variable)) %>% mutate(FC = !!sym(intGrp[1])/!!sym(intGrp[2]))  
    
    fc_desc <- fc_stats %>% group_by(Gender) %>% summarise(FC = paste0(round(mean(FC),3), " ± ", round(sd(FC),3))) %>% 
      tidyr::pivot_wider(names_from = Gender, values_from = FC) %>% mutate(Comparison = paste0(intGrp, collapse = ""))
    
    colnames(fc_desc)[1:2] <- c("FC(male)", "FC(female)")
    
    fc_wilcox <- fc_stats %>% group_by(Gender) %>% count() %>% pivot_wider(id_cols = c(Gender, n), names_from = Gender, values_from = n)
    fc_wilcox <- data.frame(Test = "noTest", group1 = colnames(fc_wilcox)[1], group2 = colnames(fc_wilcox)[2], "n1" = as.numeric(fc_wilcox[1,1]), "n2" = as.numeric(fc_wilcox[1,2]), statistic = "noStat", p = 1)
    
    try(fc_wilcox <- fc_stats %>% rstatix::wilcox_test(FC ~ Gender), silent = T)
    
    cbind(fc_desc, fc_wilcox)
  })
  
  fc_stats_pairs_gender <- do.call("rbind", FC_stats)[,-4]
  fc_stats_pairs_gender <- fc_stats_pairs_gender %>% as.data.frame() %>% dplyr::mutate("p.adj(BY)" = p.adjust(p,"BY"))
    
     pairs_result_list <- list(stats = stats_groups, 
                               stats_groups_gender = stats_groups_gender,
                               fc_stats_pairs_gender, 
                               stats_ats = stats_ats,
                               fc_stats_pairs = fc_stats_pairs)
     
  }
  
  return(pairs_result_list)
  
}

rankTest_year <- function(ds, variable, consider_gender = T){
  
  year_groups <- unique(ds$year)
  
  res_nparLD <- c()
  stats_ats <- c()
  
  if(consider_gender){
    
    res_nparLD <- sapply(year_groups, function(yearGrp){
    
      ds_sub_interval <- as.data.frame(ds %>% filter(year %in% yearGrp) %>% droplevels())
      res <- f2.ld.f1(y = ds_sub_interval %>% pull(!!sym(variable)), 
                      time = as.character(ds_sub_interval$IntGroup), 
                      group1 = as.character(ds_sub_interval$AgeCat), 
                      group2 = as.character(ds_sub_interval$Gender), 
                      subject = as.character(ds_sub_interval$ID), 
                      time.order = levels(ds_sub_interval$IntGroup), 
                      group1.name = "Age", group2.name = "Gender", plot.RTE = F, description = FALSE)
    res
  }, simplify = T)
    
    stats_ats <- data.frame(Factor = c("Age", "Gender", "Time-Interval", "Age:Gender", "Age:Time-Interval", "Gender:Time-Interval", "Age:Gender:Time-Interval"), 
                          group1 = 2019, group2 = 2020, 
                          do.call("rbind", apply(res_nparLD, 2, function(elem)elem$ANOVA.test))) %>% dplyr::select(!df)
    
  }else{
    
    text_formula <- paste0(variable," ~  IntGroup * AgeCat")
  
    res_nparLD <- sapply(year_groups, function(yearGrp){
      res <- nparLD(eval(parse(text = text_formula)), data = as.data.frame(ds %>% filter(year %in% yearGrp)), 
                    subject = "ID", description = FALSE, plot.CI = FALSE)
      res
  }, simplify = F)
    
    stats_ats <- data.frame(Year = rep(year_groups, each = 3),
                          Factor = c("Age", "Time-Interval", "Age:Time-Interval"), 
                          do.call("rbind", lapply(res_nparLD, function(elem)elem$ANOVA.test))) %>% dplyr::select(!df)
  }

  stats_ats <- data.frame(stats_ats, "p.adj(BY)" = p.adjust(stats_ats$p.value, method = "BY"), check.names = F) %>% 
    mutate(Statistic = format(Statistic, digits = 2), 
           p.value = format(p.value, digits = 2, scientific = T), 
           `p.adj(BY)` = as.numeric(format(`p.adj(BY)`, digits = 2, scientific = T)),
           significant = case_when((`p.adj(BY)` >= 0.05) ~ "ns",
                                   (`p.adj(BY)` < 0.05 & `p.adj(BY)` >= 0.01) ~ "<0.05",
                                   (`p.adj(BY)` < 0.01 & `p.adj(BY)` >= 0.001) ~ "<0.01",
                                   (`p.adj(BY)` < 0.001 & `p.adj(BY)` >= 0.0001) ~ "<0.001",
                                   (`p.adj(BY)` < 0.0001 & `p.adj(BY)` >= 0) ~ "<0.0001"))
 
stats_groups <- ds %>% group_by(year, AgeCat) %>% 
    summarise("Mean ± SD" = paste0(round(mean(!!sym(variable)), 2), " ± ",round(sd(!!sym(variable)), 2)))
  
 fc_stats <- ds %>% dplyr::select(ID, year, !!sym(variable), AgeCat) %>% group_by(ID, year, AgeCat) %>% 
             summarise(meanYear = mean(!!sym(variable))) %>%
             tidyr::pivot_wider(names_from = year, values_from = meanYear) %>% mutate(FC = `2019`/`2020`)  
    
  fc_desc <- fc_stats %>% group_by(AgeCat) %>% summarise(FC = paste0(round(mean(FC),3), " ± ", round(sd(FC),3))) %>% 
      tidyr::pivot_wider(names_from = AgeCat, values_from = FC) %>% mutate(Comparison = "2019/2020")
    
  colnames(fc_desc)[1:2] <- c("FC(old)", "FC(young)")
    
  w_test <- wilcox.test(fc_stats %>% filter(AgeCat == "young") %>% pull(FC), fc_stats %>% filter(AgeCat == "old") %>% pull(FC))
  
  fc_stats <- data.frame(fc_desc, statistic = w_test$statistic, p = w_test$p.value, check.names = F, stringsAsFactors = F)
  
  if(!consider_gender){
    
    stats_ats_time <- data.frame(Year = rep(year_groups, each = 2), 
                               Age = c("old", "young"),
                               do.call("rbind", lapply(res_nparLD, function(elem)elem$ANOVA.test.time))) %>% dplyr::select(!df)
    
    stats_ats_time <- stats_ats_time %>% inner_join(stats_groups, by = c("Age" = "AgeCat", "Year" = "year")) 
  
    stats_ats_time <- stats_ats_time[,c(1:2, 5, 3:4)]
  
    stats_ats_time <- data.frame(stats_ats_time, "p.adj(BY)" = p.adjust(stats_ats_time$p.value, method = "BY"), check.names = F) %>% 
      mutate(significant = case_when((`p.adj(BY)` >= 0.05) ~ "ns",
                                     (`p.adj(BY)` < 0.05 & `p.adj(BY)` >= 0.01) ~ "<0.05",
                                     (`p.adj(BY)` < 0.01 & `p.adj(BY)` >= 0.001) ~ "<0.01",
                                     (`p.adj(BY)` < 0.001 & `p.adj(BY)` >= 0.0001) ~ "<0.001",
                                     (`p.adj(BY)` < 0.0001 & `p.adj(BY)` >= 0) ~ "<0.0001"))
    
    res_list <- list(stats = stats_groups, fc_stats = fc_stats, stats_ats = stats_ats, stats_ats_time = stats_ats_time)
    
  }else{
    
    stats_groups_gender <- ds %>% group_by(year, Gender) %>% 
    summarise("Mean ± SD" = paste0(round(mean(!!sym(variable)), 2), " ± ",round(sd(!!sym(variable)), 2)))
  
 fc_stats_gender <- ds %>% dplyr::select(ID, year, !!sym(variable), Gender) %>% group_by(ID, year, Gender) %>% 
                    summarise(meanYear = mean(!!sym(variable))) %>%
                    tidyr::pivot_wider(names_from = year, values_from = meanYear) %>% mutate(FC = `2019`/`2020`)  
    
  fc_desc_gender <- fc_stats_gender %>% group_by(Gender) %>% summarise(FC = paste0(round(mean(FC),3), " ± ", round(sd(FC),3))) %>% 
      tidyr::pivot_wider(names_from = Gender, values_from = FC) %>% mutate(Comparison = "2019/2020")
    
  colnames(fc_desc_gender)[1:2] <- c("FC(male)", "FC(female)")
    
  w_test <- wilcox.test(fc_stats_gender %>% filter(Gender == "male") %>% pull(FC), fc_stats_gender %>% filter(Gender == "female") %>% pull(FC))
  
  fc_stats_gender <- data.frame(fc_desc_gender, statistic = w_test$statistic, p = w_test$p.value)
  
  res_list <- list(stats = stats_groups, fc_stats = fc_stats, fc_stats_gender = fc_stats_gender, stats_groups_gender = stats_groups_gender, stats_ats = stats_ats)
    
  }
  
  return(res_list)
}
```

### Define Intervals and occurences of first cases

```{r}
lockDownDates <-  as.Date(c("2020-01-01", "2020-03-21", "2020-05-06", "2020-08-04", "2020-11-03","2020-12-16", "2020-12-31"))
lockdownLabs <- as.Date(c("2020-01-01", "2020-03-21", "2020-05-06", "2020-08-04", "2020-11-03","2020-12-16"))
  
for(i in seq_along(lockDownDates[-1])){
  lockdownLabs[i] <- as.Date(lockDownDates[i] + diff.Date(lockDownDates[i:(i+1)])/2)
}
first_cases <- as.Date(c("2020-01-27", "2020-03-03"))
```

### Ploting directory 

```{r}
super_plot.dir <- "plots/"

if(!file.exists(super_plot.dir)){
  dir.create(super_plot.dir)
}
```

# Data set

```{r, message=FALSE}
data_set <- readr::read_delim(file = "data/physical_activity_cied_patients.csv.gz", delim=";")
w_days <- c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun")
data_set$Weekday <- factor(data_set$Weekday, levels = w_days)
```

## General information (Table 1)

```{r}
vars <- c("Age", "Gender", "Activity", "Device", "Indication")

general_information <- sapply(vars, function(variable){
  df <- c()
  if(variable == "Age"){
    
    df <- data_set %>% dplyr::select(ID,!!sym(variable)) %>% unique() %>% summarise( Feature = "Age",
                                                                                     'relative' =  paste0(round(median(!!sym(variable)),1), " ± ", round(mad(!!sym(variable)),1)),
                                                                                     'absolute' = "(Median(Age) ± MAD(Age))")
    
  }else if(variable == "Activity"){
    
    df <- summarise_intervals(ds = filter_complete_dataset(ds = data_set, variable = variable), variable = "Activity") %>%
          group_by(year) %>% summarise('relative' = paste0(format(mean(!!sym(variable)),digits = 3), " ± ", format(sd(!!sym(variable)),digits = 2)),
                                       'absolute' = "(Mean(Activity) ± SD(Activity))") %>% dplyr::rename(Feature = year)
    
  }else{
    
    df <- data_set %>% dplyr::select(ID,!!sym(variable)) %>% unique() %>% group_by(!!sym(variable)) %>% 
          summarise(relative = round(length(!!sym(variable))/  data_set %>% dplyr::select(ID) %>% unique() %>% nrow() * 100, 2),
                    absolute = length(!!sym(variable)))
    
  }
  colnames(df) <- c("Feature","relative (%)", "absolute")
  df$`relative (%)` <- format(df$`relative (%)`, scientific = F, digits=3)
  df
}, simplify = F)

general_information <- as.data.frame(do.call("rbind", general_information))
rownames(general_information) <- general_information$Feature

kable(general_information[,-1], row.names = T) %>% 
  kableExtra::pack_rows("Age", 1, 1) %>%
  kableExtra::pack_rows("Gender", 2, 3) %>%
  kableExtra::pack_rows("Mean physical activity, % of day", 4, 5) %>%
  kableExtra::pack_rows("Device", 6, 11) %>%
  kableExtra::pack_rows("Indication", 12, 14) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```


# Physical activity

```{r}
variable <- "Activity"
x <- "Date"
  
plot.dir <- file.path(super_plot.dir, variable)
  
if(!file.exists(plot.dir)){
  dir.create(plot.dir, recursive = T)
}

file_name <- file.path(plot.dir, paste0(variable,""))
```

Filter data set according to available activity data. Each subject in the study should have activity values within all 12 predefined time intervals.

```{r}
ds_activity <- filter_complete_dataset(ds = data_set, variable = variable)
ds_activity_corrected <- filter_complete_dataset(ds = data_set, variable = variable, correct_weekday = T)
```

Averaging activity of each day over all patients.

```{r}
ds_act_date <- ds_activity %>% group_by(Date, year, IntGroup, Interval) %>% 
        summarise(!!variable := mean(!!sym(variable)), .groups = 'drop')

n_subjects <- length(unique(ds_activity$ID))
```

## Figure 1

### Mean activity and seasonal variations in 2019 and 2020

```{r, fig.width=8, fig.height=6}
ylim_y <- ds_act_date %>% summarise(min = floor(min(!!sym(variable))), 
                                    max = ceiling(max(!!sym(variable)))) %>% as.numeric()
        

long_plt_19 <- plot_longitude(ds = ds_act_date %>% filter(year == 2019), 
                              x = x, variable = variable, ylim = ylim_y, 
                              lockDownDates = lockDownDates - 365, 
                              first_cases = NULL, 
                              lockdownLabs = lockdownLabs - 365, 
                              n_subs = n_subjects, sel_year = 2019)

long_plt_20 <- plot_longitude(ds = ds_act_date %>% filter(year == 2020), 
                              x = x, variable = variable, ylim = ylim_y, 
                              lockDownDates = lockDownDates, 
                              first_cases = first_cases, 
                              lockdownLabs = lockdownLabs, 
                              n_subs = n_subjects, sel_year = 2020)
  
long_plot <- cowplot::plot_grid(
    long_plt_19 + 
      ggplot2::xlab("Time intervals") +
      ggplot2::ylab("Mean physical activity (% of day)") +
      ggplot2::ggtitle(label = "2019") + 
      ggplot2::theme(plot.title = ggplot2::element_text(face = "bold.italic"),
                     axis.text.x = ggplot2::element_blank(), 
                     plot.margin = ggplot2::margin(t = 0, b=0)),
    
    long_plt_20 + 
      ggplot2::xlab("Time intervals") + 
      ggplot2::ylab("Mean physical activity (% of day)") +
      ggplot2::ggtitle(label = "2020") + 
      ggplot2::theme(plot.title = ggplot2::element_text(face = "bold.italic"),
                     axis.text.x = ggplot2::element_blank(),
                     plot.margin = ggplot2::margin(t = 0, b=0),
                     ),
    nrow = 2,ncol = 1)

long_plot
ggsave(plot = long_plot, filename = paste0(file_name, "_longitude_plot.pdf"), device = "pdf", height = 6, width = 8)
ggsave(plot = long_plot, filename = paste0(file_name, "_longitude_plot.svg"), device = "svg", height = 6, width = 8)
```

## Mean weekday physical activity of patients

Here, we want to analyse the recurring reduction of physical acitvity of patients during the end of the week, especially on Sundays.
We calculate the average weekday activity of each patient during each time interval. The average weekday activity for each patient at each time interval is defined as the arithmetic mean of each patient over the same weekday (Monday, Tuesday, ...) during one particular time interval. To determine significant differences, we perform a paired non-parametric test for each time interval and each pariwise combination of weekdays.

```{r, message = FALSE, results='hide'}
ds_week <- data_set %>% dplyr::select(ID, IntGroup, Interval, year, Weekday, Activity) %>% group_by(ID, IntGroup, Interval, year, Weekday) %>% summarise(meanActivity = mean(Activity, na.rm = T))
ds_week$Interval <- factor(ds_week$Interval, levels = paste0(rep(unique(ds_week$IntGroup), 2), rep(c(19,20), each = length(unique(ds_week$IntGroup)))))

ids_in_IntDays<- ds_week %>% mutate(IntDay = paste0(Interval, Weekday)) %>% group_by(ID) %>% summarise(nIntDays = length(unique(IntDay))) %>% filter(nIntDays == 84) %>% pull(ID)

ds_week <- ds_week %>% filter(ID %in% ids_in_IntDays)

day_groups <- levels(ds_week$Weekday)
day_combs <- combn(x = day_groups, m = 2)

int_list <- list()

for(i in seq_along(levels(ds_week$Interval))){
  
  sel_interval <- levels(ds_week$Interval)[i]
  
  res_nparLD <- c()
  
  res_nparLD <- apply(day_combs, 2, function(dayGrp){
    
      sub_ds <- as.data.frame(ds_week %>% filter(Weekday %in% dayGrp & Interval == sel_interval) %>% droplevels())
      
      res <- ld.f1(y = sub_ds %>% pull(meanActivity), 
                      time = as.character(sub_ds$Weekday),
                      time.order = levels(sub_ds$Weekday),
                      subject = as.character(sub_ds$ID),
                      plot.RTE = FALSE, description = FALSE)
    res
  })
  int_list[[i]] <- data.frame(Interval = sel_interval, group1 = day_combs[1,], group2 = day_combs[2,], do.call("rbind", lapply(res_nparLD, function(elem)elem$ANOVA.test)))
}

weekday_analysis <- do.call("rbind", int_list) %>% mutate(`p.adj(BY)` = p.adjust(p.value, method = "BY")) %>% filter(`p.adj(BY)` < 0.05)
```

We see that all pairwise comparisons with Sundays show significant differences in mean physical activity. In contrast, we could only find a few pairwise comparisons between other weekdays showing significant differences.

```{r}
kable(weekday_analysis %>% dplyr::arrange(Interval, group1, group2), row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left") %>% 
 scroll_box(width = "450px", height = "550px")
```

### Recurring reduction of patients acitvity on Sundays

The following plot shows the average weekday physical activity over all patients (black dots) with errorbars representing the standard deviation of weekday physical activity over all patients.

```{r, fig.height = 7.5, fig.width = 10, message = FALSE, results='hide'}
ds_week_sum <- data_set %>% dplyr::filter(ID %in% ids_in_IntDays) %>% 
                            dplyr::select(ID, IntGroup, Interval, year, Weekday, Activity) %>% 
                            dplyr::group_by(IntGroup, Interval, year, Weekday) %>% 
                            dplyr::summarise(meanActivity = mean(Activity, na.rm = TRUE),
                                             sdActivity = sd(Activity, na.rm = TRUE)) %>% 
                            dplyr::mutate(IntDay = paste0(Interval, Weekday),
                                          IntDayLabel =  paste0(IntGroup, "-" ,Weekday))
ds_week_sum$Interval <- factor(ds_week_sum$Interval, levels = paste0(rep(unique(ds_week_sum$IntGroup), 2), rep(c(19,20), each = length(unique(ds_week_sum$IntGroup)))))
ds_week_sum$IntDay <- factor(ds_week_sum$IntDay, levels = paste0(rep(levels(ds_week_sum$Interval), each = length(levels(ds_week_sum$Weekday))), rep(levels(ds_week_sum$Weekday), times = length(levels(ds_week_sum$Interval)))))

week_plt_list <- list()
for(i in seq_along(unique(ds_week_sum$year))){
  
  week_ds_sub <- ds_week_sum %>% filter(year == unique(ds_week_sum$year)[i]) 
  week_plt_list[[i]] <- ggplot2::ggplot(week_ds_sub, ggplot2::aes(x = IntDay, y = meanActivity, group = 1)) + 
    scale_x_discrete(labels = as.character(week_ds_sub %>% pull(Weekday))) + 
    geom_tile(aes(fill = Weekday), width = 1, height = Inf, alpha = 0.3) +
    labs(fill = "Weekday") + 
    ggplot2::scale_fill_manual(values = c(rep("#ffffff00", 6), "red")) + 
    geom_errorbar(aes(ymin=meanActivity-sdActivity, ymax=meanActivity+sdActivity), width=.5) +
    geom_line(lwd = 1.1) +
    geom_point(size = 3) + 
    ggStyle_ts +
    ggplot2::geom_vline(xintercept = seq(from = 7.5, by = 7, 42), lwd = 1.25) + 
    ggplot2::annotate(geom="label", x = seq(from = 4, by = 7, 42), size = 4, y = 2.5, 
                      label = LETTERS[1:6]) +
    ggplot2::theme(legend.position = "none",
                   axis.title.x = ggplot2::element_blank()) + 
    ggplot2::ggtitle(unique(ds_week_sum$year)[i]) + 
    ggplot2::ylab("Mean weekday physical activity (% of day)")
}

weekday_act_plt <- cowplot::plot_grid(plotlist = week_plt_list, ncol = 1, nrow = 2)
weekday_act_plt
ggsave(plot = weekday_act_plt, filename = paste0(file_name, "_weekday_plot.pdf"), device = "pdf", height = 7.5, width = 10)
ggsave(plot = weekday_act_plt, filename = paste0(file_name, "_weekday_plot.svg"), device = "svg", height = 7.5, width = 10)
```

## Summarizing physical activity for each time interval

We averaged the activity of each patient over each predefined time interval in 2019 and 2020.

```{r}
ds_act_interval <- summarise_intervals(ds = ds_activity, variable = variable)
```

## Distribution of physical activity values

### QQ-Plot of physical activity

```{r}
qqplot_activity <- ds_act_interval %>% dplyr::select(IntGroup, Interval, year, !!sym(variable)) %>% mutate(year = factor(year, c(2019, 2020))) %>%
  ggplot2::ggplot(ggplot2::aes(sample=!!sym(variable))) +
  ggplot2::stat_qq(distribution = stats::qnorm) + ggplot2::geom_qq_line() + ggplot2::facet_wrap(~IntGroup + year) + 
  ggStyle + 
  ggplot2::ylab("Actual Activity") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 0, hjust = 0.5)) +
  ggplot2::xlab("Theoretical Activity")
ggsave(plot = qqplot_activity, filename = paste0(file_name, "_qqplot.pdf"), device = "pdf", height = 10, width = 10)
ggsave(plot = qqplot_activity, filename = paste0(file_name, "_qqplot.svg"), device = "svg", height = 10, width = 10)
qqplot_activity
```

### Shapiro-Wilk test of normality

```{r}
shpiro_test_activity <- ds_act_interval %>% dplyr::select(IntGroup, Interval, year, !!sym(variable)) %>% mutate(year = factor(year, c(2019, 2020))) %>% group_by(IntGroup, year) %>% rstatix::shapiro_test(!!sym(variable)) %>% dplyr::select(!variable) %>% dplyr::rename(`Time interval` = IntGroup, `p value` = p)

kable(shpiro_test_activity, row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```

### QQ-Plot of logarithmic physical activity

```{r}
qqplot_log_activity <- ds_act_interval %>% dplyr::select(IntGroup, Interval, year, !!sym(variable)) %>% mutate(year = factor(year, c(2019, 2020))) %>% mutate(logActivity = log(!!sym(variable))) %>%
  ggplot2::ggplot(ggplot2::aes(sample=logActivity)) +
  ggplot2::stat_qq(distribution = stats::qnorm) + ggplot2::geom_qq_line() + ggplot2::facet_wrap(~IntGroup + year) + 
  ggStyle + 
  ggplot2::ylab("Actual Activity") + 
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 0, hjust = 0.5)) +
  ggplot2::xlab("Theoretical Activity")
ggsave(plot = qqplot_log_activity, filename = paste0(file_name, "_log_qqplot.pdf"), device = "pdf", height = 10, width = 10)
ggsave(plot = qqplot_log_activity, filename = paste0(file_name, "_log_qqplot.pdf"), device = "svg", height = 10, width = 10)
qqplot_log_activity
```

### Shapiro-Wilk test of normality of logarithmic activity values

```{r}
shpiro_test_log_activity <- ds_act_interval %>% mutate(logActivity = log(!!sym(variable))) %>% dplyr::select(IntGroup, Interval, year, logActivity) %>% mutate(year = factor(year, c(2019, 2020))) %>% group_by(IntGroup, year) %>% rstatix::shapiro_test(logActivity) %>% dplyr::select(!variable) %>% dplyr::rename(`Time interval` = IntGroup, `p value` = p)

kable(shpiro_test_log_activity, row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```


Physical activity data is not normally distributed. Hence, we perform a non-parametric test on physical activity data averaged over predefined time intervals to determine statistically significant differences within and between 2019 and 2020. We chose the `nparLD` package to calculate a non-parametric two-factorial of longitudinal data to model the influence of the different time intervals and the age of the subjects.  


### Non-parametric pairwise tests between time intervals 

We consider beside time also age and gender as factors that may have an impact on the patients activity. Since the data is not normally distributed, we perform a rank based factor analysis.

```{r, message = FALSE, results='hide'}
age_gender_time <- rankTest_pairwise(ds = ds_act_interval, variable = variable, consider_gender = T)
```


After filtering for significant differences, there is no significant effect of gender that influences the physical activity.
```{r}
kable(age_gender_time$stats_ats %>% filter(significant != "ns") %>% dplyr::arrange(group1, group2), row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left") %>% 
 scroll_box(width = "550px", height = "200px")
```

## Figure 2

### Comparison of physical activity between time intervals within 2019 and 2020. 

Modeling gender as a factor additional to age, we see that the differences between time intervals E and F in 2019 are not significant.

```{r}
bxp19 <- boxplot_year(ds = ds_act_interval, variable, main_title = "2019", show.legend = F, legend.labels = NULL, ylabel = "Mean physical activity (% of day)",
                      ymax = NULL, stats = age_gender_time$stats_ats, pairs = paste0(LETTERS[1:5],"19",LETTERS[2:6],"19"), sel_year = 2019)

bxp20 <- boxplot_year(ds = ds_act_interval, variable, main_title = "2020", show.legend = F, legend.labels = NULL, ylabel = "Mean physical activity (% of day)",
                      ymax = NULL, stats = age_gender_time$stats_ats, pairs = paste0(LETTERS[1:5],"20",LETTERS[2:6],"20"), sel_year = 2020)

bxp19_20_grid <- cowplot::plot_grid(bxp19, bxp20, ncol = 2)
ggsave(plot = bxp19_20_grid, filename = paste0(file_name, "_boxplot_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp19_20_grid, filename = paste0(file_name, "_boxplot_years.svg"), device = "svg", height = 5, width = 10)

bxp19_20_grid
```

## Figure 3

### Comparison of physical activity between corresponding time intervals of 2019 and 2020

Time intervals A and D between 2019 and 2020 do not show any significant differences in physical activity.

```{r}
bxp1920 <- boxplot_1920(ds = ds_act_interval, variable, main_title = NULL,
                        stats = age_gender_time$stats_ats, xlabel = "Time interval", ylabel = "Mean physical activity (% of day)")
ggsave(plot = bxp1920, filename = paste0(file_name, "_boxplots_between_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp1920, filename = paste0(file_name, "_boxplots_between_years.svg"), device = "svg", height = 5, width = 10)
bxp1920
```

### Physical activity of CIED-patients between time intervals 2019 and 2020

Now, we consider the changes within each year 2019 and 2020. Similar to the pairwise comparisons, we do not see any significant differences based on gender. In contrast, we see that age and time show significant differences in physical activity.

```{r, message = FALSE, results = 'hide'}
stats_years_gender <- rankTest_year(ds = ds_act_interval, variable = variable, consider_gender = T)
```

#### Mean Activity male vs. female

Mean physical activity and standard deviation over all male and female patients.

```{r}
kable(stats_years_gender$stats_groups_gender, row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left") 
```

#### Foldchange between male and female

Foldchanges, i.e., relative changes of activity between male and female patients are also not significantly different. We calculated the foldchange values of each patients within each year. Afterwards, we calculated the mean and standard deviation of these foldchange values for each gender group between 2019 and 2020. The foldchanges of male and female patients for 2019 and 2020 are not significantly different.

```{r}
kable(stats_years_gender$fc_stats_gender, row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left") 
```

#### Results longitudinal activity analysis of 2019 and 2020

```{r}
kable(stats_years_gender$stats_ats %>% filter(significant != "ns"), row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```


The following analysis does not consider gender as a factor, due to the non-significant influences shown in the previous analyses.
Now, we model physical activity depending on age and time. We defined age categories young (<70 years) and old (≥70 years).
 
```{r, message = FALSE, results='hide'}
age_time <- rankTest_pairwise(ds = ds_act_interval, variable = variable, consider_gender = F)
```

Significant pairwise comparisons between all possible pairs of time intervals. To correct for multiple testing, we performed the adjustment of p values based on the Benjamini-Yekutieli method. 

```{r}
kable(age_time$stats_ats %>% filter(significant != "ns") %>% dplyr::arrange(group1, group2), row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left") %>% 
 scroll_box(width = "550px", height = "200px")
```


## Figure 2 without consideration of gender effects

### Physical activity between time intervals within 2019 and 2020

Compared to the previous analysis, we now see a slightly significant difference between the time intervals E and F in 2019. The low p value and the previous analysis including gender effects, suggest that the differences between these time intervals could be due to low gender effects.

```{r}
bxp19 <- boxplot_year(ds = ds_act_interval, variable, main_title = "2019", ylabel = "Mean physical activity (% of day)",
                      ymax = NULL, stats = age_time$stats_ats, pairs = paste0(LETTERS[1:5],"19",LETTERS[2:6],"19"), sel_year = 2019)

bxp20 <- boxplot_year(ds = ds_act_interval, variable, main_title = "2020", ylabel = "Mean physical activity (% of day)", 
                      ymax = NULL, stats = age_time$stats_ats, pairs = paste0(LETTERS[1:5],"20",LETTERS[2:6],"20"), sel_year = 2020)

bxp19_20_grid <- cowplot::plot_grid(bxp19, bxp20, ncol = 2)
ggsave(plot = bxp19_20_grid, filename = paste0(file_name, "_boxplot_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp19_20_grid, filename = paste0(file_name, "_boxplot_years.svg"), device = "svg", height = 5, width = 10)

bxp19_20_grid
```

## Figure 3 without consideration of gender effects

### Physical activity between corresponding time intervals 2019 and 2020

Compared to Figure 3 of the previous analysis, we see significant changes between the corresponding time intervals A and D between 2019 and 2020. Shown in Figure 4.2, these differences are due to the reduction of activity of older patients between 2019 and 2020. Since, the corresponding p values are slightly significant, this difference is not characteristic for the whole population of old and young patients.

```{r}
bxp1920 <- boxplot_1920(ds = ds_act_interval, variable, main_title = NULL, 
                        stats = age_time$stats_ats, xlabel = "Time interval", ylabel = "Mean physical activity (% of day)", legend.labels = c(2019, 2020), show.legend = T)
ggsave(plot = bxp1920, filename = paste0(file_name, "_boxplots_between_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp1920, filename = paste0(file_name, "_boxplots_between_years.svg"), device = "svg", height = 5, width = 10)
bxp1920
```

## Figure 4.1

### Physical activity for separate age categories in 2019 and 2020


```{r, fig.width=10, fig.height=10}
bxp19_age <- boxplot_year(ds = ds_act_interval, variable, main_title = "2019", ylabel = "Mean physical activity (% of day)",
                      ymax = NULL, stats = age_time$stats_ats_time, pairs = paste0(LETTERS[1:5],"19",LETTERS[2:6],"19"), sel_year = 2019, sep_age = T)


bxp20_age <- boxplot_year(ds = ds_act_interval, variable, main_title = "2020", ylabel = "Mean physical activity (% of day)", 
                      ymax = NULL, stats = age_time$stats_ats_time, pairs = paste0(LETTERS[1:5],"20",LETTERS[2:6],"20"), sel_year = 2020, sep_age = T)

bxp19_20_age_grid <- cowplot::plot_grid(bxp19_age, bxp20_age, ncol = 1)
ggsave(plot = bxp19_20_age_grid, filename = paste0(file_name, "_boxplots_old_young_within_years.pdf"), device = "pdf", height = 10, width = 10)
ggsave(plot = bxp19_20_age_grid, filename = paste0(file_name, "_boxplots_old_young_within_years.svg"), device = "svg", height = 10, width = 10)
bxp19_20_age_grid
```

## Figure 4.2

### Physical activity of CIED-patients within age groups between corresponding time intervals

```{r}
bxp1920_age <- boxplot_1920(ds = ds_act_interval, variable, main_title = NULL, 
                      ymax = NULL, stats = age_time$stats_ats_time, sep_age = T, xlabel = "Time interval", ylabel = "Mean physical activity (% of day)")
ggsave(plot = bxp1920_age, filename = paste0(file_name, "_boxplots_old_young_between_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp1920_age, filename = paste0(file_name, "_boxplots_old_young_between_years.svg"), device = "svg", height = 5, width = 10)
bxp1920_age
```

### Comparison of Fold-Changes between young and old patients

```{r}
kable(age_time$fc_stats_pairs %>% filter(Comparison %in% c(paste0(LETTERS[1:5],"19",LETTERS[2:6],"19"),paste0(LETTERS[1:5],"20",LETTERS[2:6],"20"))) %>% dplyr::select(-group1, -group2, -statistic), row.names = F) %>% 
  kableExtra::pack_rows("2019", 1, 5) %>%
  kableExtra::pack_rows("2020", 6, 10) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```

### Comparison of Fold-Changes between young and old patients

```{r}
kable(age_time$fc_stats_pairs %>% filter(Comparison %in% c(paste0(LETTERS[1:6],"19",LETTERS[1:6],"20"))) %>% dplyr::select(-group1, -group2, -statistic), row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```

### Physical activity of CIED-patients between time intervals 2019 and 2020

```{r, message = FALSE, results='hide'}
stats_years <- rankTest_year(ds = ds_act_interval, variable = variable, consider_gender = F)
```

#### Mean Activity old and young

```{r}
kable(stats_years$stats, row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left") 
```

#### Foldchange between old and young

```{r}
kable(stats_years$fc_stats, row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left") 
```

#### Table: Activity 2019 and 2020

```{r}
kable(stats_years$stats_ats %>% filter(significant != "ns"), row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```

#### Table: Activity 2019 and 2020 separate for old and young

```{r}
kable(stats_years$stats_ats_time %>% filter(significant != "ns"), row.names = F) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), full_width = F, position = "left")
```

# Average Heart Rate (HR)

## HR within 2019 and 2020
```{r, message = FALSE, results='hide'}
variable = "AvgHeartRate"

plot.dir <- file.path(super_plot.dir, variable)
  
if(!file.exists(plot.dir)){
  dir.create(plot.dir, recursive = T)
}

file_name <- file.path(plot.dir, paste0(variable,""))

ds_hr_filter <- filter_complete_dataset(ds = data_set, variable = variable)
ds_hr_interval <- summarise_intervals(ds = ds_hr_filter, variable = variable)

age_time_hr <- rankTest_pairwise(ds = ds_hr_interval, variable = variable, consider_gender = T)

bxp19_hr <- boxplot_year(ds = ds_hr_interval, variable, main_title = "2019", 
                        ymax = NULL, stats = age_time_hr$stats_ats, pairs = paste0(LETTERS[1:5],"19",LETTERS[2:6],"19"), sel_year = 2019, ylabel = "Average HR")

bxp20_hr <- boxplot_year(ds = ds_hr_interval, variable, main_title = "2020", 
                        ymax = NULL, stats = age_time_hr$stats_ats, pairs = paste0(LETTERS[1:5],"20",LETTERS[2:6],"20"), sel_year = 2020, ylabel = "Average HR")

bxp19_20hr_grid <- cowplot::plot_grid(bxp19_hr, bxp20_hr, ncol = 2)
ggsave(plot = bxp19_20hr_grid, filename = paste0(file_name, "_boxplot_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp19_20hr_grid, filename = paste0(file_name, "_boxplot_years.svg"), device = "svg", height = 5, width = 10)

bxp19_20hr_grid
```

## Figure 5: 

### Average HR of CIED-patients between corresponding time intervals 2019 and 2020

```{r}
bxp1920_hr <- boxplot_1920(ds = ds_hr_interval, variable, main_title = NULL, show.legend = T, legend.labels = c(2019, 2020),
                           stats = age_time_hr$stats_ats, xlabel = "Time interval", ylabel = "Average HR")
ggsave(plot = bxp1920_hr, filename = paste0(file_name, "_boxplots_between_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp1920_hr, filename = paste0(file_name, "_boxplots_between_years.svg"), device = "svg", height = 5, width = 10)
bxp1920_hr
```


# Average resting Heart Rate (rHR)

## rHR within  2019 and 2020
```{r, message = FALSE, results='hide'}
variable = "AvgRestingHeartRate"
plot.dir <- file.path(super_plot.dir, variable)
  
if(!file.exists(plot.dir)){
  dir.create(plot.dir, recursive = T)
}

file_name <- file.path(plot.dir, paste0(variable,""))

ds_rhr_filter <- filter_complete_dataset(ds = data_set, variable = variable)
ds_rhr_interval <- summarise_intervals(ds = ds_rhr_filter, variable = variable)

age_time_rhr <- rankTest_pairwise(ds = ds_rhr_interval, variable = variable, consider_gender = F)

bxp19_rhr <- boxplot_year(ds = ds_rhr_interval, variable, main_title = "2019", 
                      ymax = NULL, stats = age_time_rhr$stats_ats, pairs = paste0(LETTERS[1:5],"19",LETTERS[2:6],"19"), sel_year = 2019, ylabel = "Average rHR")

bxp20_rhr <- boxplot_year(ds = ds_rhr_interval, variable, main_title = "2020", 
                      ymax = NULL, stats = age_time_rhr$stats_ats, pairs = paste0(LETTERS[1:5],"20",LETTERS[2:6],"20"), sel_year = 2020, ylabel = "Average rHR")

bxp19_20rhr_grid <- cowplot::plot_grid(bxp19_rhr, bxp20_rhr, ncol = 2)
ggsave(plot = bxp19_20_grid, filename = paste0(file_name, "_boxplot_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp19_20_grid, filename = paste0(file_name, "_boxplot_years.svg"), device = "svg", height = 5, width = 10)

bxp19_20rhr_grid
```

## Figure 6: 

### Average rHR of CIED-patients between corresponding time intervals 2019 and 2020

```{r}
bxp1920_rhr <- boxplot_1920(ds = ds_rhr_interval, variable, show.legend = T, legend.labels = c(2019, 2020), 
                            stats = age_time_rhr$stats_ats, xlabel = "Time interval", ylabel = "Average rHR")
ggsave(plot = bxp1920_rhr, filename = paste0(file_name, "_boxplots_between_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp1920_rhr, filename = paste0(file_name, "_boxplots_between_years.svg"), device = "svg", height = 5, width = 10)
bxp1920_rhr
```

# Atrial Arrhythmia Burden (AAB)

## AAB within 2019 and 2020
```{r, message = FALSE, results='hide'}
variable = "AtrialArrhythmicBurden"

plot.dir <- file.path(super_plot.dir, variable)
  
if(!file.exists(plot.dir)){
  dir.create(plot.dir, recursive = T)
}

file_name <- file.path(plot.dir, paste0(variable,""))

ds_aab_filter <- filter_complete_dataset(ds = data_set, variable = variable)
ds_aab_interval <- summarise_intervals(ds = ds_aab_filter, variable = variable)

ds_aab_interval <- ds_aab_interval %>% filter(!!sym(variable) != 0) %>% group_by(ID) %>% mutate(n = length(ID)) %>% filter(n == 12) %>% dplyr::select(-n)

age_time_aab <- rankTest_pairwise(ds = ds_aab_interval, variable = variable, consider_gender = T)

bxp19_aab <- boxplot_year(ds = ds_aab_interval, variable, main_title = "2019", 
                        ymax = NULL, stats = age_time_aab$stats_ats, pairs = paste0(LETTERS[1:5],"19",LETTERS[2:6],"19"),
                        sel_year = 2019, ylabel = "Atrial Arrhythmia Burden")

bxp20_aab <- boxplot_year(ds = ds_aab_interval, variable, main_title = "2020", 
                        ymax = NULL, stats = age_time_aab$stats_ats, pairs = paste0(LETTERS[1:5],"20",LETTERS[2:6],"20"), 
                        sel_year = 2020, ylabel = "Atrial Arrhythmia Burden")

bxp19_20aab_grid <- cowplot::plot_grid(bxp19_aab, bxp20_aab, ncol = 2)
ggsave(plot = bxp19_20aab_grid, filename = paste0(file_name, "_boxplot_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp19_20aab_grid, filename = paste0(file_name, "_boxplot_years.svg"), device = "svg", height = 5, width = 10)

bxp19_20aab_grid
```

## Figure 7 

### Atrial Arrhythmia Burden of CIED-patients between corresponding time intervals 2019 and 2020

```{r}
bxp1920_aab <- boxplot_1920(ds = ds_aab_interval, variable, main_title = NULL, show.legend = T, legend.labels = c(2019, 2020),
                        stats = age_time_aab$stats_ats, xlabel = "Time interval", ylabel = "Atrial Arrhythmia Burden")
ggsave(plot = bxp1920_aab, filename = paste0(file_name, "_boxplots_between_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp1920_aab, filename = paste0(file_name, "_boxplots_between_years.svg"), device = "svg", height = 5, width = 10)
bxp1920_aab
```

# Thoracic Impedance

## Thoracic Impedance within 2019 and 2020
```{r, message = FALSE, results='hide'}
variable = "ThoracicImpedance"

plot.dir <- file.path(super_plot.dir, variable)

if(!file.exists(plot.dir)){
  dir.create(plot.dir, recursive = T)
}

file_name <- file.path(plot.dir, paste0(variable,""))

ds_ti_filter <- filter_complete_dataset(ds = data_set, variable = variable)
ds_ti_interval <- summarise_intervals(ds = ds_ti_filter, variable = variable)

age_time_ti <- rankTest_pairwise(ds = ds_ti_interval, variable = variable, consider_gender = T)

bxp19_ti <- boxplot_year(ds = ds_ti_interval, variable, main_title = "2019",
                        ymax = NULL, stats = age_time_ti$stats_ats, pairs = paste0(LETTERS[1:5],"19",LETTERS[2:6],"19"),
                        sel_year = 2019, ylabel = "Thoracic Impedance")

bxp20_ti <- boxplot_year(ds = ds_ti_interval, variable, main_title = "2020",
                        ymax = NULL, stats = age_time_ti$stats_ats, pairs = paste0(LETTERS[1:5],"20",LETTERS[2:6],"20"),
                        sel_year = 2020, ylabel = "Thoracic Impedance")

bxp19_20ti_grid <- cowplot::plot_grid(bxp19_ti, bxp20_ti, ncol = 2)
ggsave(plot = bxp19_20ti_grid, filename = paste0(file_name, "_boxplot_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp19_20ti_grid, filename = paste0(file_name, "_boxplot_years.svg"), device = "svg", height = 5, width = 10)

bxp19_20ti_grid
```

## Figure 8

### Thoracic Impedance between corresponding time intervals 2019 and 2020

```{r}
bxp1920_ti <- boxplot_1920(ds = ds_ti_interval, variable,  main_title = NULL, show.legend = T, legend.labels = c(2019, 2020),
                        stats = age_time_ti$stats_ats, xlabel = "Time interval", ylabel = "Thoracic Impedance")
ggsave(plot = bxp1920_ti, filename = paste0(file_name, "_boxplots_between_years.pdf"), device = "pdf", height = 5, width = 10)
ggsave(plot = bxp1920_ti, filename = paste0(file_name, "_boxplots_between_years.svg"), device = "svg", height = 5, width = 10)
bxp1920_ti
```

# ICD - Therapies

Prepare data set to consider only patients showing ICD therapies within the 12 time intervals.
The number of ATPs are summed within each time interval for each patient.

## ATP events
```{r, message = FALSE, results='hide'}
variable = "ATPevents"
plot.dir <- file.path(super_plot.dir, variable)
  
if(!file.exists(plot.dir)){
  dir.create(plot.dir, recursive = T)
}

file_name <- file.path(plot.dir, paste0(variable,""))

ds_atp_interval <- get_icd_data(ds = data_set, variable = variable)
```

Get the IDs of patients with ATP events during the 12 time intervals.
```{r, message = FALSE, results='hide'}
ids_with_shock <- ds_atp_interval %>% group_by(ID) %>% summarise(sumVar = (sum(!!sym(variable)) > 0)) %>% 
  filter(sumVar > 0) %>% pull(ID) %>% droplevels()

ds_atp_interval <- ds_atp_interval %>% filter(ID %in% ids_with_shock)
```

Only `r length(ids_with_shock)` patients show ATP events. One patients shows 54 events. We remove this outlier for further analyses of ATP events.
```{r, message = FALSE, results='hide'}
ATP_years <- ds_atp_interval %>% group_by(ID, year) %>% summarise(sumATP = sum(!!sym(variable))) %>% tidyr::pivot_wider(names_from = year, values_from = sumATP)

ggplot2::ggplot(ATP_years, ggplot2::aes(x = `2019`, y = `2020`)) +
    ggplot2::geom_point() +
    ggplot2::xlab("ATPs in 2019") +
    ggplot2::ylab("ATPs in 2020") +
    ggStyle +
    ggplot2::theme(axis.text = ggplot2::element_text(angle=0)) + 
    ggrepel::geom_label_repel(data = ATP_years %>% filter(`2019` > 40), ggplot2::aes(label = ID), nudge_x = -5, nudge_y = 2)
ggsave(plot = last_plot(), filename = paste0(file_name, "_ATP_scatterplot.pdf"), device = "pdf", height = 5, width = 5)
ggsave(plot = last_plot(), filename = paste0(file_name, "_ATP_scatterplot.svg"), device = "svg", height = 5, width = 5)
```

```{r, message = FALSE, results='hide', warnings = FALSE}
ds_atp_interval <- ds_atp_interval %>% filter(ID != "PA_CD_057") %>% droplevels()

event_barplot(ds = ds_atp_interval %>% group_by(year, IntGroup) %>% summarise(ATPevents = sum(!!sym(variable))), variable = variable, xlabel = "Time interval", ylabel = "Number of ATP events")
ggsave(plot = last_plot(), filename = paste0(file_name, "_ATP_barplot.pdf"), device = "pdf", height = 5, width = 5)
ggsave(plot = last_plot(), filename = paste0(file_name, "_ATP_barplot.svg"), device = "svg", height = 5, width = 5)
```

## ICD-shocks

```{r, message = FALSE, results='hide', warnings = FALSE}
variable = "ICDshocks"
plot.dir <- file.path(super_plot.dir, variable)
  
if(!file.exists(plot.dir)){
  dir.create(plot.dir, recursive = T)
}

file_name <- file.path(plot.dir, paste0(variable,""))

get_icd_data <- function(ds, variable){
  
  ds_filter <- filter_complete_dataset(ds = data_set, variable = variable)
  ds_interval <- summarise_intervals(ds = ds_filter, variable = variable, add = T)

}

ds_shocks_interval <- get_icd_data(ds = data_set, variable = variable)
```

Get the IDs of patients with ICD-shocks during the 12 time intervals.
```{r, message = FALSE, results='hide', warnings = FALSE}
ids_with_shock <- ds_shocks_interval %>% group_by(ID) %>% summarise(sumVar = (sum(!!sym(variable)) > 0)) %>% 
  filter(sumVar > 0) %>% pull(ID) %>% droplevels()

ds_shocks_interval <- ds_shocks_interval %>% filter(ID %in% ids_with_shock)
```

Only `r length(ids_with_shock)` patients show ICD-shocks. The patient with 54 ATP events also shows 3 ICD-shocks. We remove this patient from the analysis of ICD-shocks.
```{r, message = FALSE, results='hide', warnings = FALSE}
shocks_years <- ds_shocks_interval %>% group_by(ID, year) %>% summarise(sumSchocks = sum(!!sym(variable))) %>% tidyr::pivot_wider(names_from = year, values_from = sumSchocks)

pos <- position_jitter(width = 0.1, height = 0.1, seed = 1)

ggplot2::ggplot(shocks_years, ggplot2::aes(x = `2019`, y = `2020`)) +
    ggplot2::geom_point(position = pos) +
    ggplot2::xlab("Shocks in 2019") +
    ggplot2::ylab("Shocks in 2020") +
    ggStyle + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle=0))  + 
    ggrepel::geom_label_repel(data = shocks_years %>% filter(ID == "PA_CD_057"), ggplot2::aes(label = ID), position = pos)
ggsave(plot = last_plot(), filename = paste0(file_name, "_shocks_scatterplot.pdf"), device = "pdf", height = 5, width = 5)
ggsave(plot = last_plot(), filename = paste0(file_name, "_shocks_scatterplot.svg"), device = "svg", height = 5, width = 5)
```

Based on the histograms, there seems to be no visible differences between 2019 and 2020.

```{r, message = FALSE, results='hide', warnings = FALSE}
ds_shocks_interval <- ds_shocks_interval %>% filter(ID != "PA_CD_057") %>% droplevels()
ds_shocks_sum <- ds_shocks_interval %>% group_by(year, IntGroup) %>% summarise(ICDshocks = sum(!!sym(variable)))
event_barplot(ds = ds_shocks_sum, variable = variable, xlabel = "Time interval", ylabel = "Number of ICD-shocks")
ggsave(plot = last_plot(), filename = paste0(file_name, "_shocks_barplot.pdf"), device = "pdf", height = 5, width = 5)
ggsave(plot = last_plot(), filename = paste0(file_name, "_shocks_barplot.svg"), device = "svg", height = 5, width = 5)
```